name: Push to main

on:
  push:
    branches: [main]

jobs:
  tests:
      uses: salesforcecli/github-workflows/.github/workflows/unitTest.yml@main
  release:
    runs-on: ubuntu-latest
    container:
      image: node:lts
    needs:
    - tests
    steps:
    - uses: actions/download-artifact@v2
    - uses: actions/checkout@v3
    - name: Configuring GitHub
      run: |-
        git config credential.helper 'cache --timeout=120'
        git config user.email "$GH_EMAIL"
        git config user.name "Release Bot"
    - name: Bump package version
      run: |-
        yarn
        yarn bump-versions 'minor'
        git add .
        export RELEASE_TAG="$(node -pe "require('./lerna.json').version")"
        git commit -m "Updated version $RELEASE_TAG [ci skip]"
    - name: Set .npmrc
      run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
    - run: yarn publish-lsp
    - run: git push origin main
    - name: Tag the release and push to repo
      run: |-
        export RELEASE_TAG="$(node -pe "require('./lerna.json').version")"
        git tag v${RELEASE_TAG}
        git push --tags
    - name: Create Github Release
      uses: actions/create-release@v1
      if: ${{ steps.changelog.outputs.skipped == 'false' }}
      env:
        GITHUB_TOKEN: ${{ secrets.SF_IDEE_BOT_GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.changelog.outputs.tag }}
        release_name: ${{ steps.changelog.outputs.tag }}
        body: ${{ steps.changelog.outputs.clean_changelog }}